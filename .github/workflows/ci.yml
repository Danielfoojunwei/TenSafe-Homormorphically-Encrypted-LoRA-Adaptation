name: CI

on:
  push:
    branches: [main, "release/**"]
  pull_request:
    branches: [main]

jobs:
  # ==========================================================================
  # LINT + TYPE CHECK
  # ==========================================================================
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff mypy

    - name: Ruff lint
      run: ruff check src/ tests/

    - name: Mypy type check
      run: mypy src/tensorguard/ --ignore-missing-imports

  # ==========================================================================
  # BUILD WHEEL + TEST
  # ==========================================================================
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install build tools
      run: python -m pip install --upgrade pip build

    - name: Build wheel
      run: python -m build --wheel --outdir dist/

    - name: Install from wheel with dev extras
      run: |
        pip install dist/*.whl
        pip install "tensafe[dev]" --find-links dist/

    - name: Compile check
      run: python -m compileall src/

    - name: Verify all packages importable from wheel
      run: |
        python -c "
        import tensafe, tensorguard, tg_tinker, crypto_backend, he_lora_microkernel
        from crypto_backend.ckks_moai import MOAIContext
        assert tensorguard.__version__ == tensafe.__version__ == tg_tinker.__version__
        print(f'All packages OK at v{tensorguard.__version__}')
        "

    - name: Run tests (skip GPU-heavy suites)
      env:
        TENSAFE_ENV: dev
        PYTHONPATH: src
      run: |
        pytest tests/unit/ -q --tb=short -x \
          -m "not slow and not integration" \
          --ignore=tests/unit/test_tg_tinker

    - name: Upload wheel artifact
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: tensafe-wheel-${{ github.sha }}
        path: dist/*.whl
        retention-days: 30

  # ==========================================================================
  # SECURITY AUDIT
  # ==========================================================================
  audit:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install and audit
      run: |
        python -m pip install --upgrade pip build
        python -m build --wheel --outdir dist/
        pip install dist/*.whl
        pip install pip-audit
        pip-audit --strict --desc 2>&1 || true

  # ==========================================================================
  # REPO HYGIENE
  # ==========================================================================
  hygiene:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: No __pycache__ or .pyc in repo
      run: |
        if find . -path ./.git -prune -o -name '__pycache__' -print -o -name '*.pyc' -print | grep -q .; then
          echo "FAIL: Found __pycache__ or .pyc files in repo"
          find . -path ./.git -prune -o -name '__pycache__' -print -o -name '*.pyc' -print
          exit 1
        fi
        echo "OK: No compiled Python artifacts in repo"

    - name: No .pytest_cache in repo
      run: |
        if find . -path ./.git -prune -o -name '.pytest_cache' -print | grep -q .; then
          echo "FAIL: Found .pytest_cache in repo"
          exit 1
        fi
        echo "OK: No pytest cache in repo"

  # ==========================================================================
  # DOCKER BUILD + SMOKE TEST
  # ==========================================================================
  docker:
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: |
        docker build -t tensafe:ci-${{ github.sha }} \
          --build-arg TENSAFE_SKIP_HE_CHECK=1 .

    - name: Smoke test â€” healthz
      run: |
        docker run -d --name tensafe-smoke \
          -e TENSAFE_ENV=dev \
          -e DATABASE_URL=sqlite:///./test.db \
          -p 8000:8000 \
          tensafe:ci-${{ github.sha }}

        # Wait for startup
        for i in $(seq 1 30); do
          if curl -sf http://localhost:8000/healthz > /dev/null 2>&1; then
            echo "OK: /healthz returned 200"
            break
          fi
          sleep 1
        done

        # Verify response
        curl -sf http://localhost:8000/healthz | python3 -c "
        import json, sys
        data = json.load(sys.stdin)
        assert data['status'] == 'ok', f'Unexpected: {data}'
        print('PASS: healthz check')
        "

        docker stop tensafe-smoke
        docker rm tensafe-smoke
